@{
    ViewData["Title"] = "Danh sách và chi tiết";
}
<style>
    .lesson-container {
        margin-top: 30px;
    }

    .lesson-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        padding: 32px 24px;
        margin-bottom: 24px;
    }

    .lesson-title {
        text-align: center;
        color: #1976d2;
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 24px;
    }
    /* cho nội dung dùng flow bình thường (không dùng align-items:center vì iframe cần chiều cao tự nhiên) */
    .lesson-content {
        min-height: 220px;
    }

        .lesson-content img, .lesson-content video, .lesson-content iframe {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            background: #f8f9fa;
            display: block;
            margin: 0 auto;
        }
        /* đảm bảo iframe/figure từ CKEditor có chiều cao phù hợp */
        .ck-content iframe, .lesson-content iframe {
            width: 100% !important;
            height: 400px !important;
        }

    .ck-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
    }

    .list-group-item.active {
        background: #1976d2 !important;
        color: #fff !important;
        font-weight: 600;
        border-color: #1976d2 !important;
    }

    .list-group-item {
        cursor: pointer;
        font-size: 1.05rem;
    }
</style>

<div class="container lesson-container">
    <h2 id="tenLoaiBangLai" class="mb-4">Danh sách bài học</h2>
    <div class="row">
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white"><h5 class="mb-0">Chọn bài học</h5></div>
                <div class="card-body p-0"><div id="listBaiHoc" class="list-group list-group-flush"></div></div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="lesson-card">
                <div id="tieuDeBaiHoc" class="lesson-title"></div>
                <div id="noiDung" class="lesson-content"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function getLoaiBangLaiId() { return new URLSearchParams(window.location.search).get('loaiBangLaiId'); }
        function loadTenLoaiBangLai(id) {
            if (!id) return;
            fetch('/api/LoaiBangLai/' + id).then(r => r.json()).then(d => {
                const ten = d.tenLoai ?? d.data?.tenLoai ?? d.data?.TenLoai;
                if (ten) document.getElementById('tenLoaiBangLai').innerText = 'Danh sách bài học - ' + ten;
            }).catch(console.error);
        }

        function loadDanhSachBaiHoc(loaiBangLaiId) {
            fetch('/api/SaHinh/get-all-bai-sa-hinh').then(r => r.json()).then(data => {
                const arr = data.data ?? [];
                const list = arr.filter(b => String(b.loaiBangLai?.id ?? b.loaiBangLai?.Id) === String(loaiBangLaiId));
                const container = document.getElementById('listBaiHoc');
                container.innerHTML = '';
                if (!list.length) { container.innerHTML = '<div class="p-3 text-muted">Không có bài học nào</div>'; $('#tieuDeBaiHoc').text(''); $('#noiDung').html(''); return; }
                list.forEach((bai, idx) => {
                    const id = bai.id ?? bai.Id;
                    const title = bai.tenBai ?? bai.TenBai;
                    const order = bai.order ?? bai.Order;
                    const a = document.createElement('a');
                    a.href = '#';
                    a.className = 'list-group-item list-group-item-action baiHocLink' + (idx === 0 ? ' active' : '');
                    a.dataset.id = id;
                    a.innerText = `Bài ${order}: ${title}`;
                    container.appendChild(a);
                });
                loadBaiHoc(list[0].id ?? list[0].Id);
                $('.baiHocLink').click(function (e) { e.preventDefault(); $('.baiHocLink').removeClass('active'); $(this).addClass('active'); loadBaiHoc($(this).data('id')); });
            }).catch(console.error);
        }

        function decodeHtmlEntities(input) {
            const ta = document.createElement('textarea');
            ta.innerHTML = input;
            return ta.value;
        }

        function loadBaiHoc(baiHocId) {
            $('#tieuDeBaiHoc').text('Đang tải...');
            $('#noiDung').html('');
            fetch('/api/SaHinh/' + baiHocId).then(r => r.json()).then(data => {
                console.log('SaHinh detail:', data);
                if (!(data.status && data.data)) { $('#tieuDeBaiHoc').text('Không tìm thấy bài học'); return; }
                const bai = data.data;
                const title = bai.tenBai ?? bai.TenBai ?? '';
                $('#tieuDeBaiHoc').text(title);

                let nd = (bai.noiDung ?? bai.NoiDung ?? '') + '';
                // nếu server trả escaped HTML (&lt;iframe&gt;...), decode về tags thực
                if (nd.includes('&lt;') && nd.includes('&gt;')) nd = decodeHtmlEntities(nd);

                const containsHtml = /<[^>]+>/i.test(nd);
                let html = '';

                if (!nd || nd.trim() === '') {
                    html = '<i class="text-muted">Không có nội dung</i>';
                } else if (containsHtml) {
                    // nếu chứa <iframe> hoặc figure.media (CKEditor) -> render trực tiếp
                    html = `<div class="ck-content">${nd}</div>`;
                } else {
                    // fallback: nếu là url tới video/image hoặc youtube
                    const url = nd.trim();
                    const youtubeIdMatch = url.match(/[?&]v=([A-Za-z0-9_-]{6,})/) || url.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/) || url.match(/embed\/([A-Za-z0-9_-]{6,})/);
                    const youtubeId = youtubeIdMatch ? youtubeIdMatch[1] : null;
                    if (youtubeId) {
                        html = `<iframe width="100%" height="400" src="https://www.youtube.com/embed/${youtubeId}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    } else if (/(\/.*\.(mp4|webm|ogg|mov))$/i.test(url.split('?')[0])) {
                        const src = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
                        html = `<video controls style="max-width:100%; border-radius:12px;"><source src="${src}" type="video/mp4">Trình duyệt không hỗ trợ video.</video>`;
                    } else if (/(\/.*\.(jpg|jpeg|png|gif|bmp|webp))$/i.test(url.split('?')[0])) {
                        const src = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
                        html = `<img src="${src}" style="max-width:100%; border-radius:12px;" />`;
                    } else {
                        html = `<p>${$('<div/>').text(nd).html()}</p>`;
                    }
                }

                $('#noiDung').html(html);
            }).catch(err => {
                console.error('loadBaiHoc err', err);
                $('#tieuDeBaiHoc').text('Lỗi tải nội dung');
                $('#noiDung').html('');
            });
        }

        $(document).ready(function () {
            const loaiBangLaiId = getLoaiBangLaiId();
            if (!loaiBangLaiId) { alert("Không tìm thấy loại bằng lái."); return; }
            loadTenLoaiBangLai(loaiBangLaiId);
            loadDanhSachBaiHoc(loaiBangLaiId);
        });
    </script>
}