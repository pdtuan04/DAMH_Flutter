@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2>Chi tiết người dùng</h2>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-12">
                    <h4>Thông tin người dùng</h4>
                    <table class="table table-bordered">
                        <tr>
                            <th style="width: 150px;">ID:</th>
                            <td><span id="userId"></span></td>
                        </tr>
                        <tr>
                            <th>Username:</th>
                            <td><span id="userName"></span></td>
                        </tr>
                        <tr>
                            <th>Email:</th>
                            <td><span id="email"></span></td>
                        </tr>
                        <tr>
                            <th>Created At:</th>
                            <td><span id="createdAt"></span></td>
                        </tr>
                        <tr>
                            <th>Vai trò:</th>
                            <td><span id="roles"></span></td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="d-flex justify-content-between">
                <a href="/Admin/QuanLyUser" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Quay lại
                </a>
                <button id="updateRoleButton" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Cập nhật vai trò
                </button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let roleList = [];

        $(document).ready(function () {
            const userId = getUserIdFromUrl();
            $('#userId').text(userId);
            loadUserDetails(userId);
            loadRoleList();

            $('#updateRoleButton').on('click', function () {
                updateUserRole(userId);
            });
        });

        function getUserIdFromUrl() {
            const url = window.location.pathname;
            const parts = url.split('/');
            return parts[parts.length - 1];
        }

        async function loadRoleList() {
            try {
                const response = await fetch('/api/Manager/role-list');
                if (response.ok) {
                    const result = await response.json();
                    if (result.status && result.data) {
                        roleList = result.data.map(r => r.name); // Assuming roles have 'name' property
                    }
                }
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }

        function loadUserDetails(id) {
            fetch('/api/Manager/get-user-by-id/' + id, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status && data.data) {
                    const user = data.data;
                    $('#userName').text(user.userName || '');
                    $('#email').text(user.email || '');
                    if (user.createAt) {
                        const date = new Date(user.createAt);
                        $('#createdAt').text(date.toLocaleString('vi-VN', { timeZone: 'UTC' }));
                    } else {
                        $('#createdAt').text('');
                    }
                    $('#roles').text(user.role && user.role.length > 0 ? user.role.join(', ') : 'Không có');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Không thể tải thông tin người dùng'
                    }).then(() => {
                        window.location.href = '/Admin/QuanLyUser';
                    });
                }
            })
            .catch(() => {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Đã xảy ra lỗi khi tải thông tin người dùng'
                }).then(() => {
                    window.location.href = '/Admin/QuanLyUser';
                });
            });
        }

        async function updateUserRole(userId) {
            if (roleList.length === 0) {
                await Swal.fire('Lỗi!', 'Không thể tải danh sách vai trò.', 'error');
                return;
            }

            const currentRoles = $('#roles').text();
            const { value: newRole } = await Swal.fire({
                title: 'Cập nhật vai trò',
                input: 'select',
                inputOptions: roleList.reduce((acc, role) => {
                    acc[role] = role;
                    return acc;
                }, {}),
                inputPlaceholder: 'Chọn vai trò mới',
                showCancelButton: true,
                confirmButtonText: 'Cập nhật',
                cancelButtonText: 'Hủy',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Bạn cần chọn một vai trò!';
                    }
                }
            });

            if (newRole) {
                const result = await Swal.fire({
                    title: 'Xác nhận?',
                    text: `Bạn có muốn thay đổi vai trò thành "${newRole}"?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Có',
                    cancelButtonText: 'Hủy'
                });

                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`/api/Manager/set-role-user/${userId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(newRole)
                        });

                        const data = await response.json();
                        if (data.status) {
                            await Swal.fire('Thành công!', 'Vai trò đã được cập nhật.', 'success');
                            loadUserDetails(userId); // Reload details to update roles display
                        } else {
                            await Swal.fire('Lỗi!', data.message || 'Cập nhật thất bại.', 'error');
                        }
                    } catch (error) {
                        console.error('Error updating role:', error);
                        await Swal.fire('Lỗi!', 'Có lỗi xảy ra khi cập nhật vai trò.', 'error');
                    }
                }
            }
        }

        function getToken() {
            return localStorage.getItem('jwtToken') || '';
        }
    </script>
}