@{
    ViewData["Title"] = "Thêm bài sa hình";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container mt-5">
    <h2 class="mb-4">Thêm bài sa hình</h2>

    <form id="createForm">
        <div class="form-group">
            <label for="TenBai">Tên bài</label>
            <input type="text" id="TenBai" class="form-control" required />
        </div>

        <div class="form-group">
            <label for="Order">Thứ tự</label>
            <input type="number" id="Order" class="form-control" required />
        </div>

        <!-- CKEditor thay thế upload ảnh/video -->
        <div class="form-group">
            <label for="NoiDung">Nội dung *</label>
            <textarea id="NoiDung" class="form-control"></textarea>
        </div>

        <div class="form-group">
            <label for="LoaiBangLaiId">Loại bằng lái</label>
            <select id="LoaiBangLaiId" class="form-control" required></select>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Thêm bài</button>
    </form>
</div>

@section Scripts {
    <!-- CKEditor -->
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>

    <script>
        // Load danh sách loại bằng lái
        fetch('/api/LoaiBangLai/get-loai-bang-lai-list')
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById("LoaiBangLaiId");
                data.data.forEach(loai => {
                    const option = document.createElement("option");
                    option.value = loai.id;
                    option.text = loai.tenLoai;
                    select.appendChild(option);
                });
            });

        // CUSTOM UPLOAD ADAPTER (Upload ảnh & video)
        class UploadAdapter {
            constructor(loader) {
                this.loader = loader;
            }

            upload() {
                return this.loader.file.then(file => new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append("file", file);

                    let uploadUrl = file.type.startsWith("video/")
                        ? "/api/Upload/upload-video"
                        : "/api/Upload/upload-image";

                    fetch(uploadUrl, {
                        method: "POST",
                        body: formData
                    })
                        .then(res => res.json())
                        .then(result => {
                            if (!result.status) {
                                reject(result.message);
                                return;
                            }

                            resolve({
                                default: result.filePath
                            });
                        })
                        .catch(err => reject(err));
                }));
            }

            abort() { }
        }

        function CustomUploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                return new UploadAdapter(loader);
            };
        }

        let editorInstance;

        // Khởi tạo CKEditor
        ClassicEditor
            .create(document.querySelector('#NoiDung'), {
                extraPlugins: [CustomUploadAdapterPlugin],
                mediaEmbed: { previewsInData: true }
            })
            .then(editor => editorInstance = editor)
            .catch(err => console.error(err));

        // Submit form
        document.getElementById("createForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const data = {
                TenBai: document.getElementById("TenBai").value,
                Order: parseInt(document.getElementById("Order").value),
                NoiDung: editorInstance.getData(),
                LoaiBangLaiId: document.getElementById("LoaiBangLaiId").value
            };

            const resCreate = await fetch("/api/SaHinh/create", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            const result = await resCreate.json();

            if (result.status) {
                alert("Thêm bài sa hình thành công!");
                location.href = "/Admin/QLSaHinh";
            } else {
                alert("Lỗi: " + result.message);
            }
        });
    </script>
}
