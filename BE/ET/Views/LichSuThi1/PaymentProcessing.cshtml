@{
    ViewData["Title"] = "Đang xử lý thanh toán...";
    var orderId = ViewData["OrderId"] ?? "N/A";
}

<div class="container" style="max-width: 600px; margin-top: 110px; text-align:center;">
    <h2 style="font-weight:600; font-size:28px; color:#1d1d1f; letter-spacing:-0.5px;">
        Đang xử lý thanh toán
    </h2>

    <p style="margin-top: 12px; font-size:15px; color:#6e6e73;">
        Mã đơn hàng: <strong style="color:#1d1d1f;">@orderId</strong>
    </p>

    <p style="margin-top: 4px; font-size:15px; color:#6e6e73;">
        Hệ thống đang xác nhận giao dịch. Vui lòng chờ trong giây lát.
    </p>

    <div style="margin-top: 36px;">
        <div class="spinner-border" role="status"
             style="width: 2.5rem; height: 2.5rem; color:#0071e3;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<script>
    // Kiểm tra trạng thái sau 4 giây
    setTimeout(async () => {
        try {
            const res = await fetch('/api/lichsuthi/check-premium-access', { credentials: 'include' });
            const data = await res.json();

            if (data?.status && data?.hasAccess) {
                window.location.href = '/LichSuThi1/PaymentSuccess';
            } else {
                // Kiểm tra lại sau 3 giây
                setTimeout(async () => {
                    const res2 = await fetch('/api/lichsuthi/check-premium-access', { credentials: 'include' });
                    const data2 = await res2.json();

                    if (data2?.status && data2?.hasAccess) {
                        window.location.href = '/LichSuThi1/PaymentSuccess';
                    } else {
                        window.location.href = '/LichSuThi1/PaymentFailed?error=Chưa xác nhận giao dịch';
                    }
                }, 3000);
            }

        } catch {
            window.location.href = '/LichSuThi1/PaymentFailed?error=Lỗi kiểm tra trạng thái';
        }
    }, 4000);
</script>
